# XOR=5/10/15锚点放入的桶位置示例

## 核心机制

1. **查找阶段**：在字符c对应的桶范围内，检查节点的第c个字符是否满足XOR=5/10/15
2. **放入阶段**：找到节点后，基于**完整geohash**的首个不同bit计算桶号

**关键点**：如果节点v在字符c位置满足XOR条件，且前c个字符都相同，那么首个不同bit必定在字符c的bit范围内，因此会落在字符c对应的桶范围内。

---

## 例子：Geohash精度=4 (TotalBits=20)

### 节点u: "wx4g"

Base32编码（0-9,b-z去掉a,i,l,o）：
- 'w' = 26
- 'x' = 27
- '4' = 4
- 'g' = 12

---

### 示例1：在字符1查找XOR=5的锚点

**查找范围**：字符1对应的桶 11-15

**场景A：前缀相同的节点**

节点v: "wx7h"
- 字符0相同：'w' = 26
- 字符1相同：'x' = 27
- 字符2不同：'4'(4) vs '7'(7), XOR = 4^7 = 3 ❌（不是5）

节点v: "wx1h"
- 字符0相同：'w' = 26
- 字符1相同：'x' = 27
- 字符2不同：'4'(4) vs '1'(1), XOR = 4^1 = 5 ✓

**计算桶号**：
- '4' = 4 = 00100 (二进制)
- '1' = 1 = 00001 (二进制)
- 首个不同bit在bit 12（字符2的第3个bit）
- bucket = 20 - 12 = **8**

**结论**：在字符1查找时，如果找到的是字符2上XOR=5的节点，会放入**桶8**

---

### 示例2：在字符2查找XOR=10的锚点

**查找范围**：字符2对应的桶 6-10

**场景：前2个字符相同**

节点v: "wx6g"
- 字符0相同：'w' = 26
- 字符1相同：'x' = 27
- 字符2不同：'4'(4) vs '6'(6), XOR = 4^6 = 2 ❌

节点v: "wxeg"
- 字符0相同：'w' = 26
- 字符1相同：'x' = 27
- 字符2不同：'4'(4) vs 'e'(14), XOR = 4^14 = 10 ✓

**计算桶号**：
- '4' = 4 = 00100 (二进制)
- 'e' = 14 = 01110 (二进制)
- XOR = 01010
- 首个不同bit在bit 11（字符2的第2个bit）
- bucket = 20 - 11 = **9**

**结论**：字符2上XOR=10的锚点放入**桶9**

---

### 示例3：在字符3查找XOR=15的锚点

**查找范围**：字符3对应的桶 1-5

**场景：前3个字符相同**

节点v: "wx4c"
- 字符0-2相同：'w', 'x', '4'
- 字符3不同：'g'(12) vs 'c'(11), XOR = 12^11 = 7 ❌

节点v: "wx4d"
- 字符0-2相同：'w', 'x', '4'
- 字符3不同：'g'(12) vs 'd'(13), XOR = 12^13 = 1 ❌

节点v: "wx43"
- 字符0-2相同：'w', 'x', '4'
- 字符3不同：'g'(12) vs '3'(3), XOR = 12^3 = 15 ✓

**计算桶号**：
- 'g' = 12 = 01100 (二进制)
- '3' = 3 = 00011 (二进制)
- XOR = 01111 (所有5个bit都不同)
- 首个不同bit在bit 15（字符3的第1个bit）
- bucket = 20 - 15 = **5**

**结论**：字符3上XOR=15的锚点放入**桶5**

---

## 规律总结

### Geohash精度=4 (TotalBits=20)的完整映射

| 字符c | 桶范围 | 在该字符上找到的XOR锚点会放入 |
|-------|--------|-------------------------------|
| 字符0 | 16-20 | **桶16-20**（字符0的5个bit对应） |
| 字符1 | 11-15 | **桶11-15**（字符1的5个bit对应） |
| 字符2 | 6-10  | **桶6-10**（字符2的5个bit对应）  |
| 字符3 | 1-5   | **桶1-5**（字符3的5个bit对应）   |

### 关键结论

✅ **在字符c查找的XOR=5/10/15锚点，会落在字符c对应的桶范围内**

原因：
1. 前c个字符都相同（通过前缀树保证）
2. 第c个字符XOR=5/10/15（查找条件）
3. 首个不同bit必定在字符c的bit范围内
4. 因此bucket必定在字符c对应的桶范围内

---

## 例子：Geohash精度=2 (TotalBits=10)

### 节点u: "wx"

#### 字符0上查找XOR=5

**查找范围**：桶6-10

找到节点v: "ux"（前缀为空，字符0: 'w'(26) vs 'u'(24), XOR=2 ❌）
找到节点v: "rx"（字符0: 'w'(26) vs 'r'(21), XOR=15 ❌）
找到节点v: "sx"（字符0: 'w'(26) vs 's'(22), XOR=4 ❌）
找到节点v: "tx"（字符0: 'w'(26) vs 't'(23), XOR=5 ✓）

- 'w' = 26 = 11010
- 't' = 23 = 10111
- 首个不同bit在bit 1
- bucket = 10 - 1 = **9**

**落在桶9**（在字符0的桶范围6-10内）

#### 字符1上查找XOR=10

**查找范围**：桶1-5

找到节点v: "wr"（前缀'w'相同，字符1: 'x'(27) vs 'r'(21), XOR=14 ❌）
找到节点v: "wn"（字符1: 'x'(27) vs 'n'(17), XOR=10 ✓）

- 'x' = 27 = 11011
- 'n' = 17 = 10001
- 首个不同bit在bit 6
- bucket = 10 - 6 = **4**

**落在桶4**（在字符1的桶范围1-5内）

---

## 总结

**答案**：每个字符c上找到的XOR=5/10/15锚点，会放入**该字符c对应的桶范围**内的某个桶。

具体是哪个桶，取决于：
1. XOR的二进制表示
2. 首个不同bit的具体位置（在字符c的5个bit中的哪一个）

但可以确定的是：**不会跑到其他字符的桶范围外**。

